<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <link rel="stylesheet" href="map4.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <!-- Include Lightbox2 CSS and JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
    
    <!-- Leaflet.markercluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <!-- Leaflet.markercluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    
    <script src="data.js" type="text/javascript"></script>
    <title>Map4</title>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <span class="logo-text">MyBeerCheckIns</span>
            </div>
            <div class="panel">
                <a href="index.html">Home</a>
                <a href="beer_terminology.html">Beerminology</a>
                <a href="map4.html">Check-in Map</a>
                <div class="dropdown">
                    <button class="dropbtn">Cartograms</button>
                    <div class="dropdown-content">
                        <a href="map1.html">Prague</a>
                        <a href="map2.html">Czech Republic</a>
                        <a href="map3.html">World</a>
                    </div>
                </div>
                <a href="statistics.html">Statistics</a>
            </div>
        </div>
    </header>
    <div id="container">
        <div id="filter-panel">
            <h3>Beer style:</h3>
            <div class = "checkbox-group filter-group">
                <div class="checkbox-pair" id = "lager-checkbox">
                    <input type="checkbox" class = "beer-style" id="Lager" checked>
                    <label for="Lager">Lager</label>
                </div>
            
                <div class="checkbox-pair" id = "ale-checkbox">
                    <input type="checkbox" class = "beer-style" id="Ale" checked>
                    <label for="Ale">Ale/APA</label>
                </div>
            
                <div class="checkbox-pair" id = "ipa-checkbox">
                    <input type="checkbox" class = "beer-style" id="IPA" checked>
                    <label for="IPA">IPA</label>
                </div>
            </div>
            <div class = "checkbox-group filter-group">
                <div class="checkbox-pair">
                    <input type="checkbox" class = "beer-style" id="Sour" checked>
                    <label for="Sour">Sour</label>
                </div>
            
                <div class="checkbox-pair">
                    <input type="checkbox" class = "beer-style" id="Stout" checked>
                    <label for="Stout">Stout/Porter</label>
                </div>
            
                <div class="checkbox-pair">
                    <input type="checkbox" class = "beer-style" id="Other" checked>
                    <label for="Other">Other</label>
                </div>
            </div>
            <h3>Serving style:</h3>
            <div class = "checkbox-group filter-group">
                <div class="checkbox-pair">
                    <input type="checkbox" class = "serving-style" id="Draft" checked>
                    <label for="Draft">Draft</label>
                </div>
            
                <div class="checkbox-pair">
                    <input type="checkbox" class = "serving-style" id="Bottle" checked>
                    <label for="Bottle">Bottle</label>
                </div>
            
                <div class="checkbox-pair">
                    <input type="checkbox" class = "serving-style" id="Can" checked>
                    <label for="Can">Can</label>
                </div>
            </div>

            <div class = "filter-group">
                <h3>Beer rating:</h3>
                <div slider id="slider-distance">
                    <div>
                    <div inverse-left style="width:95%;"></div>
                    <div inverse-right style="width:95%;"></div>
                    <div range style="left:0%;right:0%;"></div>
                    <span thumb style="left:0%;"></span>
                    <span thumb style="left:100%;"></span>
                    <div sign style="left:0%;">
                        <span id="min-value">0.25</span>
                    </div>
                    <div sign style="left:100%;">
                        <span id="max-value">5</span>
                    </div>
                    </div>
                    <input type="range" tabindex="0" value="25" max="500" min="25" step="25" oninput="
                    this.value=Math.min(this.value,this.parentNode.childNodes[5].value-1);
                    var value=(100/(parseInt(this.max)-parseInt(this.min)))*parseInt(this.value)-(100/(parseInt(this.max)-parseInt(this.min)))*parseInt(this.min);
                    var children = this.parentNode.childNodes[1].childNodes;
                    children[1].style.width=value+'%';
                    children[5].style.left=value+'%';
                    children[7].style.left=value+'%';children[11].style.left=value+'%';
                    children[11].childNodes[1].innerHTML=this.value/100;" />
                
                    <input type="range" tabindex="0" value="500" max="500" min="25" step="25" oninput="
                    this.value=Math.max(this.value,this.parentNode.childNodes[3].value-(-1));
                    var value=(100/(parseInt(this.max)-parseInt(this.min)))*parseInt(this.value)-(100/(parseInt(this.max)-parseInt(this.min)))*parseInt(this.min);
                    var children = this.parentNode.childNodes[1].childNodes;
                    children[3].style.width=(100-value)+'%';
                    children[5].style.right=(100-value)+'%';
                    children[9].style.left=value+'%';children[13].style.left=value+'%';
                    children[13].childNodes[1].innerHTML=this.value/100;" />
                </div>
            </div>

            <div class = "filter-group">
                <label for="filter-dropdown"><h3>Select a beer buddy:</h3></label>
                <select id="filter-dropdown">
                    <option value = "ALL">Anyone</option>
                    <option value = "AM">Anna Mlíková</option>
                    <option value = "ES">Eliška Sieglová</option>
                    <option value = "FZ">Filip Zadražil</option>
                    <option value = "JT">Jan Tarabec</option>
                    <option value = "JŽ">Jana Žemličková</option>
                    <option value = "LP">Luboš Petržilka</option>
                    <option value = "ME">Malcolm Edwards</option>
                    <option value = "MJ">Míra Janeček</option>
                    <option value = "MK">Michal Knížek</option>
                    <option value = "MS">Matyáš Svítok</option>
                    <option value = "PL">Petr Lhota</option>
                    <option value = "TB">Tomáš Borolič</option>
                    <option value = "TH">Terka Hofmanová</option>
                    <option value = "TS">Terka Svobodová</option>
                    <option value = "TV">Terka Vodičková</option>
                    <option value = "WS">Wenhan Sun</option>
                    <!-- Add more options as needed -->
                </select>
            </div>

            <div class = "filter-group">
                <label for="filter-dropdown"><h3>From date:</h3></label>
                <div class = "date-filters">
                    <select id="from-month">
                        <option value = "month">Month</option>
                        <option value = "1">January</option>
                        <option value = "2">February</option>
                        <option value = "3">March</option>
                        <option value = "4">April</option>
                        <option value = "5">May</option>
                        <option value = "6">June</option>
                        <option value = "7">July</option>
                        <option value = "8">August</option>
                        <option value = "9">September</option>
                        <option value = "10">October</option>
                        <option value = "11">November</option>
                        <option value = "12">December</option>
                        <!-- Add more options as needed -->
                    </select>
                    <select id="from-year">
                        <option value = "year">Year</option>
                        <option value = "2024">2024</option>
                        <option value = "2023">2023</option>
                        <option value = "2022">2022</option>
                        <!-- Add more options as needed -->
                    </select>
                </div>
            </div>

            <div class = "filter-group">
                <label for="filter-dropdown"><h3>To date:</h3></label>
                <div class = "date-filters">
                    <select id="to-month">
                        <option value = "month">Month</option>
                        <option value = "1">January</option>
                        <option value = "2">February</option>
                        <option value = "3">March</option>
                        <option value = "4">April</option>
                        <option value = "5">May</option>
                        <option value = "6">June</option>
                        <option value = "7">July</option>
                        <option value = "8">August</option>
                        <option value = "9">September</option>
                        <option value = "10">October</option>
                        <option value = "11">November</option>
                        <option value = "12">December</option>
                        <!-- Add more options as needed -->
                    </select>
                    <select id="to-year">
                        <option value = "year">Year</option>
                        <option value = "2024">2024</option>
                        <option value = "2023">2023</option>
                        <option value = "2022">2022</option>
                        <!-- Add more options as needed -->
                    </select>
                </div>
            </div>
            <button id="reset-filters">Reset Filters</button>
            <button id="apply-filters"><strong>Apply Filters</strong></button>
        </div>
        <!-- Map container -->
        <div id="map-container">
            <div id="map"></div>
        </div>

        <!-- Content box -->
        <div id="contentBox">
            <img id = "bottle" src="ikony/bottle.svg">
            <div class="box-item">
                <h2>Beer</h2>
                <p id="beerName"></p>
            </div>
        
            <div class="box-item">
                <h2>Beer Style</h2>
                <p id="beerStyle"></p>
            </div>
        
            <div class="box-item" id = "brewery-div">
                <h2>Brewery</h2>
                <p id="breweryName"></p>
            </div>

            <div class="box-item" id = "venue-div">
                <h2 id = "venue">Venue</h2>
                <p id="venueName"></p>
            </div>

            <div class="box-item same-row2">
                <div class="box-item">
                    <h2>IBU</h2>
                    <p id="ibuValue"></p>
                </div>
                <div class="box-item">
                    <h2>ABV</h2>
                    <p id="abvValue"></p>
                </div>
            </div>
        
            <div class="box-item same-row"> 
                <div>
                    <h2 class="box-item">Serving Style</h2>
                    <p id="servingStyle"></p>
                </div>
                <div class="box-item">
                    <h2>Rating</h2>
                    <div id="ratingCircles"></div>
                </div>
            </div>
        
            <div class="box-item" id="friends-div" style="display: none;">
                <h2>Friends</h2>
                <div id = "friends"></div>
            </div>
        
            <div class="box-item">
                <h2 id = "comment-text">Comment</h2>
                <p id="comment"></p>
            </div>
        
            <div class="box-item">
                <h2>Date</h2>
                <p id="checkinDate"></p>
            </div>
        
            <div class="box-item checkinPhoto">
                <a href="#" data-lightbox="checkin" data-title="Check-in Photo">
                    <img class="checkinPhoto" id="checkinPhoto">
                </a>
            </div>
        </div>
    </div>
    <script type="text/javascript">

        var map = L.map('map', {
            }
        ).setView([40, 0], 2);

        var OSmap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a> | <a href="https://www.linkedin.com/in/david-skliba/?locale=en_US" target="_blank">David Šklíba</a>',
            opacity: 0.75
        }).addTo(map);

        var Imagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 18,
            attribution:'&copy; <a href="https://www.arcgis.com/home/item.html?id=10df2279f9684e4a9f6a7f08febac2a9" target="_blank">ESRI</a> | <a href="https://www.linkedin.com/in/david-skliba/?locale=en_US" target="_blank">David Šklíba</a>',
            opacity: 0.5
        });

        var TopoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17,
            attribution:'&copy; <a href = "https://opentopomap.org/credits" target = "_blank">OpenTopoMap</a> | <a href="https://www.linkedin.com/in/david-skliba/?locale=en_US" target="_blank">David Šklíba</a>',
            opacity: 0.5
        });
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var selectedLayer = "Breweries";
        function onEachLayer(feature, layer, selectedLayer) {
            // Assuming brewery_check_ins is a dictionary with brewery IDs as keys
            if (selectedLayer === "Breweries"){
                var layerId = feature.properties.Brewery;
                var beerList = brewery_check_ins[layerId];
                var check_ins = brewery_check_ins;
            } else if (selectedLayer === "Venues"){
                var layerId = feature.properties.Venue;
                var beerList = venue_check_ins[layerId];
                var check_ins = venue_check_ins;
            }

            var placeName = layerId.replace(/ /g, "_");

            // Get the list of dictionaries for the current brewery
            var checkInsList = check_ins[layerId];
            var beerCount = checkInsList.length;

            // Construct HTML content for the popup
            var popupContent = "<div class='popup-container'>";
            popupContent += "<div class='popup-header'><b>" + layerId + "</b></div>";
            popupContent += "<div class='popup-content'><ul class='left-aligned-list'>";

            // Iterate over the list of dictionaries
            for (var i = 0; i < beerCount; i++) {
                var dict_n = checkInsList[i];
                // Access the 'Beer' property and add it to the popup content
                popupContent += '<li><a href="#" class = "box-content" id =' + placeName + "," + i + '>' + dict_n['Beer'] + '</a></li>';           
            }
            popupContent += "</ul></div>";

            // Pin the total number of check-ins to the bottom
            if (beerCount > 5) {
                popupContent += "<div class='popup-footer'><hr>Total number of beers: " + beerCount + "</div>";
                popupContent += "</div>";
            }

            // Bind the popup content to the layer
            layer.bindPopup(popupContent);
        }
        
        function addHoverEffectToLayers(layers, iconUrl) {
            layers.eachLayer(function (layer) {
                layer.on('mouseover', function () {
                    this.setIcon(L.icon({
                        iconUrl: iconUrl,
                        iconSize: [70, 70],
                        iconAnchor: [35, 70],
                        popupAnchor: [0, -50]
                    }));
                });

                layer.on('mouseout', function () {
                    this.setIcon(L.icon({
                        iconUrl: iconUrl,
                        iconSize: [50, 50],
                        iconAnchor: [25, 50],
                        popupAnchor: [0, -50]
                    }));
                });
            });
        }

        // Create a marker cluster group
        var breweryMarkers = L.markerClusterGroup();
        var venueMarkers = L.markerClusterGroup();

        // Create a GeoJSON layer with onEachFeature and pointToLayer
        var breweries = L.geoJSON(breweries_lst[0], {
            onEachFeature: function (feature, layer) {
                onEachLayer(feature, layer, selectedLayer)},
            pointToLayer: function (feature, latlng) {
                return L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: 'ikony/beer.png',
                        iconSize: [50, 50],
                        iconAnchor: [25, 50],
                        popupAnchor: [0, -50]
                    })
                });
            }
        });

        addHoverEffectToLayers(breweries, "ikony/beer.png");

        // Add the GeoJSON layer to the marker cluster group
        breweryMarkers.addLayer(breweries);

        // Add the marker cluster group to the map
        map.addLayer(breweryMarkers);
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
        function getLastDateInMonth(year, month) {
            // Month parameter is 0-indexed in JavaScript (0 for January, 1 for February, etc.)
            const lastDayOfMonth = new Date(year, month, 0);
            return lastDayOfMonth;
        }
        
        // Function to assign icon paths to friends' attributes
        function assignFriendIcons(friendsList) {
            var friendIcons = [];
            
            for (var i = 0; i < friendsList.length; i++) {
                // Assume friendsList[i] is a unique identifier for each friend
                // You may need to modify this based on your actual data structure
                var friendId = friendsList[i];
                
                // Assign an icon path for each friend
                friendIcons.push('ikony/' + friendId + '.jpg');
            }

            return friendIcons;
        }

        function displayFriendIcons(friendIcons) {
            // Clear previous friend icons
            $('#friends').empty();  // Use the correct selector

            // Iterate through the list of friends and create icons
            for (var i = 0; i < friendIcons.length; i++) {
                // Create an image element for each friend
                if (i+1 < friendIcons.length && i !== 3) {
                    var friendIcon = $('<img class="friend-picture" style="margin-right: 15px;" src="' + friendIcons[i] + '" alt="Friend Icon">');
                } else if (i > 3 && friendIcons.length == 5){
                    $('<img class="friend-picture" style="margin-right: 15px; margin-top: 15px;" src="' + friendIcons[i] + '" alt="Friend Icon">');
                } else {
                    var friendIcon = $('<img class="friend-picture" style="margin-top: 10px;" src="' + friendIcons[i] + '" alt="Friend Icon">');
                }
                
                // Append the friend icon to the #friends-div .friends element (use the correct selector)
                $('#friends').append(friendIcon);
            }
        }

        // Function to update the rating circles
        function updateRatingCircles(rating) {
            // Clear previous circles
            $('#ratingCircles').empty();

            //rating = parseFloat(rating.replace(',', '.'));
            // Define the total number of circles
            var totalCircles = 5;

            // Create and append the circles
            for (var i = 1; i < totalCircles+1; i++) {
                var circle = $('<div class="rating-circle"></div>');
                if (i <= rating) {
                    // Fill the circle
                    circle.addClass('filled');
                } else if (rating % 1 !== 0 && i-rating < 1) {
                    // Partial fill for the last circle
                    var percentage = (rating % 1)*100;
                    circle.css('background', 'conic-gradient(from 180deg, #FFD700 0%, #FFD700 ' + percentage + '%, transparent ' + percentage + '%)');
                }
                $('#ratingCircles').append(circle);
            }
        }
        
        function handleBoxContentClick(e) {
            e.preventDefault();
            var clickedId = this.id;
            var splitResult = clickedId.split(',');
            var breweryName = splitResult[0].replace(/_/g, " ");
            var popupItemIndex = splitResult[1];
            if (selectedLayer === "Breweries"){
                var check_in = brewery_check_ins[breweryName][popupItemIndex];
                if (check_in["Venue"] === null){
                    $('#venue').hide();
                    $('#venueName').hide();
                } else {
                    $('#venue').show();
                    $('#venueName').text(check_in["Venue"]);
                    $('#venueName').show();
                }
            } else if (selectedLayer === "Venues"){
                var check_in = venue_check_ins[breweryName][popupItemIndex];
                $('#breweryName').text(check_in["Brewery"]);
            }
            
            // Update content dynamically
            $('#beerName').text(check_in["Beer"]);
            $('#beerStyle').text(check_in["Beer_style"]);
            
            if (check_in["IBU"] === null){
                $('#ibuValue').text("-");
            } else {
                $('#ibuValue').text(check_in["IBU"]);
            }

            if (check_in["ABV"] === null){
                $('#abvValue').text("-");
            } else {
                $('#abvValue').text(check_in["ABV"]);
            }
            
            $('#servingStyle').text(check_in["Serving_style"]);
            if (check_in["Comment"] === null){
                $('#comment-text').hide();
                $('#comment').hide();
            } else {
                $('#comment').text(check_in["Comment"]);
                $('#comment-text').show();
                $('#comment').show();
            }
             
            $('#checkinDate').text(check_in["Date"]);

            // Fill the rating circles
            updateRatingCircles(check_in["Rating"]);

            // Show the content box
            $('#bottle').hide();
            $('.box-item').show();
            $('#contentBox').show();

            if (selectedLayer === "Breweries"){
                $('#brewery-div').hide();
            }

            if (selectedLayer === "Venues"){
                $('#venue-div').hide();
            }

            // Check if the Photo URL is defined
            if (check_in["Photo_url"] !== null) {
                // Set photo source
                $('.checkinPhoto img').attr('src', check_in["Photo_url"]);
                // Show the photo item
                $('.checkinPhoto').show();

                // Enable Lightbox for the photo
                $('.checkinPhoto a').attr('href', check_in["Photo_url"]); // Set the larger image link
                $('.checkinPhoto a').attr('data-lightbox', 'checkin'); // Set a common data attribute
            } else {
                // Hide the photo item
                $('.checkinPhoto').hide();
            }

            // Check if Friends is defined
            if (check_in["Friends"].length > 0) {
                // Show the friends item
                displayFriendIcons(assignFriendIcons(check_in["Friends"]));

                $('#friends').show();
                $('#friends-div').show();
            } else {
                // Hide the friends item
                $('#friends').hide();
                $('#friends-div').hide();            }

            // Scroll to the top of the contentBox
            $('#contentBox').scrollTop(0);
        }
        
        // Assign the function to the click event
        $(document).on('click', '.box-content', handleBoxContentClick);
        /*---------------------------------------------------------------------------------------------------"breweries"--------------------------------------------------------*/
        // Function to reset all filters to their default values
        function resetFilters() {
            // Serving style checkboxes
            document.getElementById("Draft").checked = true;
            document.getElementById("Bottle").checked = true;
            document.getElementById("Can").checked = true;
            document.getElementById("Lager").checked = true;
            document.getElementById("Ale").checked = true;
            document.getElementById("IPA").checked = true;
            document.getElementById("Sour").checked = true;
            document.getElementById("Stout").checked = true;
            document.getElementById("Other").checked = true;

            // Set default values for the two sliders
            var sliderValues = [25, 500]; // Set the desired values for each slider

            // Select the slider container
            var sliderContainer = document.getElementById("slider-distance");

            // Select the range inputs
            var rangeInputs = sliderContainer.querySelectorAll("input[type='range']");

            // Set values for each range input
            rangeInputs.forEach(function(input, index) {
                input.value = sliderValues[index];
                
                // Trigger the 'input' event to update the slider visuals
                var event = new Event('input', { bubbles: true });
                input.dispatchEvent(event);
            });

            // Select a beer buddy dropdown
            document.getElementById("filter-dropdown").value = "ALL";

            // From date dropdowns
            document.getElementById("from-month").value = "month";
            document.getElementById("from-year").value = "year";

            // To date dropdowns
            document.getElementById("to-month").value = "month";
            document.getElementById("to-year").value = "year";
        }

        function onEachFilteredBrewery(feature, layer, filters, layerName) {
            var beerStyle = filters["Beer_style"];
            var servingStyle = filters["Serving_style"];
            var friend = filters["Friend"];
            let minRating = filters["Rating"][0];
            let maxRating = filters["Rating"][1];
            let fromDate = filters["fromDate"];
            let toDate = filters["toDate"];

            if (layerName === "Breweries"){
                var layerId = feature.properties.Brewery;
                var beerList = brewery_check_ins[layerId];
            } else if (layerName === "Venues"){
                var layerId = feature.properties.Venue;
                var beerList = venue_check_ins[layerId];
            }
            var placeName = layerId.replace(/ /g, "_");
            
            var beerCount = 0;
            var beerListLen = beerList.length;
            // Construct HTML content for the popup
            var popupContent = "<div class='popup-container'>";
            popupContent += "<div class='popup-header'><b>" + layerId + "</b></div>";
            popupContent += "<div class='popup-content'><ul class='left-aligned-list'>";

            // Iterate over the list of dictionaries
            for (var i = 0; i < beerListLen; i++) {
                var dict_n = beerList[i];
                const [day, month, year] = dict_n["Date"].split('.');
                const itemDate = new Date(year, month - 1, day); 
                if (friend == 'ALL' || dict_n["Friends"].includes(friend)){
                    if (servingStyle.includes(dict_n["Serving_style"])){
                        var bS;
                        if (dict_n["Beer_style"].includes("Lager") || dict_n["Beer_style"].includes("Pilsner")){
                            bS = "Lager"
                        } else if (dict_n["Beer_style"].includes("Ale")){
                            bS = "Ale"
                        } else if (dict_n["Beer_style"].includes("IPA")){
                            bS = "IPA"
                        } else if (dict_n["Beer_style"].includes("Stout") || dict_n["Beer_style"].includes("Porter")) {
                            bS = "Stout"
                        } else if (dict_n["Beer_style"].includes("Sour")){
                            bS = "Sour"
                        } else {
                            bS = "Other"
                        }
                        let beerStyleCompliance = beerStyle.includes(bS);
                        let minRatingCompliance = parseFloat(dict_n["Rating"].replace(",", ".")) >= minRating;
                        let maxRatingCompliance = parseFloat(dict_n["Rating"].replace(",", ".")) <= maxRating;
                        let fromDateCompliance = itemDate >= fromDate;
                        let toDateCompliance = itemDate <= toDate;
                        if (minRatingCompliance && maxRatingCompliance && fromDateCompliance && toDateCompliance && beerStyleCompliance){
                        popupContent += '<li><a href="#" class = "box-content " id =' + placeName + "," + i + '>' + dict_n['Beer'] + '</a></li>';
                        beerCount += 1;
                        }
                    }
                }
                // Access the 'Beer' property and add it to the popup content
                          
            }
            popupContent += "</ul></div>";

            // Pin the total number of check-ins to the bottom
            if (beerCount > 5) {
                popupContent += "<div class='popup-footer'><hr>Total number of beers: " + beerCount + "</div>";
                popupContent += "</div>";
            }

            // Bind the popup content to the layer
            layer.bindPopup(popupContent);
        }
        var breweries = L.geoJSON();

        function breweryFilter(feature, layer, filters, layerName) {
            var beerStyle = filters["Beer_style"];
            var servingStyle = filters["Serving_style"];
            var friend = filters["Friend"];
            let minRating = filters["Rating"][0];
            let maxRating = filters["Rating"][1];
            var fromDate = filters["fromDate"];
            var toDate = filters["toDate"];

            if (layerName === "Breweries") {
                var placeName = feature.properties.Brewery;
                var beerList = brewery_check_ins[placeName];
            } else if (layerName === "Venues") {
                var placeName = feature.properties.Venue;
                var beerList = venue_check_ins[placeName];
            }

            var compliesConditions = beerList.some(function (item) {
                let minRatingCompliance = parseFloat(item.Rating.replace(",", ".")) >= minRating;
                let maxRatingCompliance = parseFloat(item.Rating.replace(",", ".")) <= maxRating;
                let servingCompliance = servingStyle.includes(item.Serving_style);
                let friendCompliance = item.Friends.includes(friend);
                const [day, month, year] = item.Date.split('.');
                const itemDate = new Date(year, month - 1, day);
                let fromDateCompliance = itemDate >= fromDate;
                let toDateCompliance = itemDate <= toDate;

                var bS;
                if (item.Beer_style.includes("Lager") || item.Beer_style.includes("Pilsner")){
                    bS = "Lager"
                } else if (item.Beer_style.includes("Ale")){
                    bS = "Ale"
                } else if (item.Beer_style.includes("IPA")){
                    bS = "IPA"
                } else if (item.Beer_style.includes("Stout") || item.Beer_style.includes("Porter")) {
                    bS = "Stout"
                } else if (item.Beer_style.includes("Sour")){
                    bS = "Sour"
                } else {
                    bS = "Other"
                }

                let beerStyleCompliance = beerStyle.includes(bS);

                if (friend == "ALL") {
                    return (
                        servingCompliance &&
                        minRatingCompliance &&
                        maxRatingCompliance &&
                        fromDateCompliance &&
                        toDateCompliance &&
                        beerStyleCompliance
                    );
                } else {
                    return (
                        servingCompliance &&
                        friendCompliance &&
                        minRatingCompliance &&
                        maxRatingCompliance &&
                        fromDateCompliance &&
                        toDateCompliance &&
                        beerStyleCompliance
                    );
                }
            });

            return compliesConditions;
        }


        function applyFilters(filters, selectedLayer){
            if (map.hasLayer(venueMarkers)) {
                map.removeLayer(venueMarkers);
            }

            if (map.hasLayer(breweryMarkers)) {
                map.removeLayer(breweryMarkers);
            }

            if (selectedLayer === "Breweries"){
                dataJsFile = breweries_lst;
                icon = "ikony/beer.png";
                breweryMarkers = L.markerClusterGroup();
            } else if (selectedLayer === "Venues"){
                dataJsFile = venues_lst;
                icon = "ikony/pub.png";
                venueMarkers = L.markerClusterGroup();
            }
            
            var newLayer = L.geoJSON(dataJsFile, {
            filter: function (feature, layer) {
                return breweryFilter(feature, layer, filters, selectedLayer);
            },
            onEachFeature: function (feature, layer) {
                onEachFilteredBrewery(feature, layer, filters, selectedLayer);
            },
            pointToLayer : function(feature, latlng) {
                        return L.marker(latlng, {
                            icon: L.icon({
                            iconUrl: icon,
                            iconSize: [50, 50], // width and height of the image in pixels
                            iconAnchor: [25, 50], // point of the icon which will correspond to marker's location
                            popupAnchor:  [0, -50],
                            })
                        });
                }       
            });
            
            if (selectedLayer === "Breweries"){
                addHoverEffectToLayers(newLayer, "ikony/beer.png");
                breweryMarkers.addLayer(newLayer);
                map.addLayer(breweryMarkers);
            } else if (selectedLayer === "Venues"){
                addHoverEffectToLayers(newLayer, "ikony/pub.png");
                venueMarkers.addLayer(newLayer)
                map.addLayer(venueMarkers);
            }    
        };
        
        document.getElementById("reset-filters").addEventListener("click", function() {
            resetFilters();
        });
        document.getElementById("apply-filters").addEventListener("click", function() {
            var selectedFilters = {"Serving_style": [], "Beer_style": []};
            var checkboxes = document.querySelectorAll('input[type="checkbox"].serving-style:checked');
            checkboxes.forEach(function (checkbox) {
                selectedFilters["Serving_style"].push(checkbox.id)
            });

            var beerStyles = document.querySelectorAll('input[type="checkbox"].beer-style:checked');
            beerStyles.forEach(function (beerStyle) {
                selectedFilters["Beer_style"].push(beerStyle.id);
            });

            // Include min and max values from the sliders
            var minValueSpan = document.getElementById('min-value');
            // Get the content of the span as a string
            var minValueString = minValueSpan.innerHTML;
            var minValue = parseFloat(minValueString);

            // Include min and max values from the sliders
            var maxValueSpan = document.getElementById('max-value');
            // Get the content of the span as a string
            var maxValueString = maxValueSpan.innerHTML;
            var maxValue = parseFloat(maxValueString);
            
            selectedFilters["Rating"] = [minValue, maxValue];

            // Get dropdown value
            var dropdown = document.getElementById('filter-dropdown');
            selectedFilters['Friend'] = dropdown.value;

            var fromMonth = document.getElementById('from-month').value;
            var fromYear = document.getElementById('from-year').value;
            var toMonth = document.getElementById('to-month').value;
            var toYear = document.getElementById('to-year').value;
            
            if (fromMonth === 'month' || fromYear === "year"){
                selectedFilters["fromDate"] = new Date(2022, 0, 1);
            } else {
                selectedFilters["fromDate"] = new Date(fromYear, fromMonth - 1, 1);
            }
            
            if (toMonth === 'month' || toYear === "year"){
                selectedFilters["toDate"] = new Date(2024, 11, 31);
            } else {
                selectedFilters["toDate"] = getLastDateInMonth(toYear, toMonth);
            }
            
            applyFilters(selectedFilters, selectedLayer);
        });
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------*/
        // Create a marker cluster group
        var venues = L.geoJSON();
           
        /*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
        var baseLayers = {
            "OS Map": OSmap,
            "Imagery": Imagery,
            "TopoMap": TopoMap
        };

        var overlayLayers = {
            "Breweries": breweries,
            "Venues": venues
        };

        var overlayControl = L.control({ position: 'topright' });

        overlayControl.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            
            // Add a white background with padding and border
            div.style.backgroundColor = 'white';
            div.style.padding = '10px';
            div.style.border = '2px solid #ccc';
            div.style.borderRadius = '5px';

            for (var i = 0; i < Object.keys(overlayLayers).length; i++) {
                var layerName = Object.keys(overlayLayers)[i];
                var checkedAttribute = i === 0 ? 'checked' : '';  // Add 'checked' for the first layer

                div.innerHTML +=
                    '<input type="radio" name="layer" value="' + layerName + '" id="' + layerName + '" ' + checkedAttribute + '>' +
                    '<label for="' + layerName + '">' + layerName + '</label><br>';
            }
            
            div.addEventListener('change', function (e) {
                selectedLayer = e.target.value;
                var zoom, center;
                resetFilters();

                if (selectedLayer === "Breweries") {
                    if (map.hasLayer(venueMarkers)) {
                        map.removeLayer(venueMarkers);
                    }

                    breweries = L.geoJSON(breweries_lst[0], {
                        onEachFeature: function (feature, layer) {
                            onEachLayer(feature, layer, selectedLayer)},
                        pointToLayer: function (feature, latlng) {
                            return L.marker(latlng, {
                                icon: L.icon({
                                    iconUrl: 'ikony/beer.png',
                                    iconSize: [50, 50],
                                    iconAnchor: [25, 50],
                                    popupAnchor: [0, -50],
                                })
                            });
                        }
                    });
                    addHoverEffectToLayers(breweries, "ikony/beer.png");

                    breweryMarkers = L.markerClusterGroup();
                    breweryMarkers.addLayer(breweries);

                    map.addLayer(breweryMarkers);
                    zoom = 2;
                    center = [40, 0];
                } else if (selectedLayer === "Venues") {
                    if (map.hasLayer(breweryMarkers)) {
                        map.removeLayer(breweryMarkers);
                    }

                    venues = L.geoJSON(venues_lst[0], {
                        onEachFeature: function (feature, layer) {
                            onEachLayer(feature, layer, selectedLayer)},
                        pointToLayer: function (feature, latlng) {
                            return L.marker(latlng, {
                                icon: L.icon({
                                    iconUrl: 'ikony/pub.png',
                                    iconSize: [50, 50],
                                    iconAnchor: [25, 50],
                                    popupAnchor: [0, -50],
                                })
                            });
                        }
                    });
                    addHoverEffectToLayers(venues, "ikony/pub.png");

                    venueMarkers = L.markerClusterGroup();
                    venueMarkers.addLayer(venues);

                    map.addLayer(venueMarkers);
                    zoom = 3;
                    center = [50.19243907905966, -19.821782223466816];
                }

                // Update the map's view based on the selected layer
                map.setView(center, zoom);
            });

            return div;
        };
        
        // Add the custom control to the map
        overlayControl.addTo(map);

        L.control.layers(baseLayers).addTo(map);
    </script>
</body>
</html>